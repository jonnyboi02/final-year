
   <template>
    <div v-if="borrower">
      {{borrower.address}}
    </div>
    <div>
      <!-- form:{
          amount: 100,
          rate: 10,
          duration: 3600,
          collateralAmount: 200,
          collateralHolder: null,
          collateralUrl: " ",
          price: 10,
        } -->
     
        Amount of Loan: <input  v-model="form.amount"/>
        <br>
        Rate: <input  v-model="form.rate"/>
        <br>
        Number of months: <input v-model="form.duration"/>
        <br>
        Collateral value: <input v-model="form.collateralAmount"/>
        <br>
        Borrower Address: <input v-model="form.collateralHolder"/>
        <br>
        Desired Price of Contract (in Ethers): <input v-model="form.price"/>


        


      <div>
        <button @click="deployLoanContract">Deploy smart contract</button>
      </div>
      <div v-if="loanContractAddress"> Contract Deployed at : {{ loanContractAddress }} </div>
    </div>
    <div>
      <button @click="changeOwner">Change Contract Owner</button>
    </div>
    <div>
      <button @click="getLoanDetails">Get Contract Details</button> 
      <p v-if="loanDetails">
        Borrower: {{ loanDetails.borrower }}<br>
        Lender: {{ loanDetails.lender }}<br>
        Owner: {{ loanDetails.owner }}<br>
        Amount: {{ loanDetails.amount }}<br>
        Rate: {{ loanDetails.rate }}<br>
        Duration: {{ loanDetails.duration }}<br>
        Due Date: {{ loanDetails.dueDate }}<br>
        Is Repaid: {{ loanDetails.isRepaid }}<br>
        Collateral Amount: {{ loanDetails.collateralAmount }}<br>
        Collateral Holder: {{ loanDetails.collateralHolder }}<br>
        Collateral URL : {{loanDetails.collateralUrl }} <br>
        Contract Price : {{loanDetails.price  }}<br>
      </p>
    </div>


  </template>
  
  <script>
  import Web3 from 'web3';
  import HelloWorld from './contracts/Test.json';
  import HelloWorldABI from './contracts/HelloWorldABI.json';
  import HelloWorldBytecode from './contracts/HelloWorldBytecode.txt';
  import Toastify from 'toastify-js';
  import 'toastify-js/src/toastify.css';
  

  import LoanABI from './contracts/LoanABI.json'
  export default {
    // mounted:{
    //   getAccounts(){
    //     this.getAccounts();
    //   }
    // },
    data() {
      return {
        contractAddress: null,
        loanContractAddress: null,
        loanContractInstance: null,
        loanDetails: null,
        accounts: null,
        borrower: null,
        form:{
          amount: 100,
          rate: 10,
          duration: 3600,
          collateralAmount: 200,
          collateralHolder: null,
          collateralUrl: " ",

          //0.5 Ether as default price
          price: 500,
        }
      };
    },
    methods: {
      async getAccounts(){
        const web3 = new Web3('http://localhost:8547');
        const accounts = await web3.eth.getAccounts();
        this.accounts = accounts;
      },
      async getLoanDetails(){
        try{
          const web3 = new Web3('http://localhost:8547');
          const accounts = await web3.eth.getAccounts();
        // const web3 = new Web3('http://localhost:8545');
        const LoanContract = new web3.eth.Contract(
          LoanABI,
          this.loanContractAddress,
        );
          const result = await LoanContract.methods.getLoanDetails().call();
          this.loanDetails = {
            borrower: result[0],
            lender: result[1],
            owner: result[2],
            amount: result[3],
            rate: result[4],
            duration: result[5],
            dueDate: result[6],
            isRepaid: result[7],
            collateralAmount: result[8],
            collateralHolder: result[9],
            collateralUrl: result[10],
            price: result[11],
          };
        }catch (error){
          Toastify({
            text: "The contract has not been deployed yet",
            backgroundColor: 'orange',
            position: 'center',
          })
        }



      },
      async changeOwner(){
          try {
            const web3 = new Web3('http://localhost:8547');
            const accounts = await web3.eth.getAccounts();
          // call changeOwner function
          await this.loanContractInstance.methods.changeOwner(accounts[2]).send({
            from: accounts[0],
            gas: 3000000,
          });
          Toastify({
            text: `Owner Changed to` + accounts[2],
            backgroundColor: 'green',
            position: 'center',
          }).showToast();
        } catch (error) {
          Toastify({
            text: 'Error Occurred when changing owner',
            backgroundColor: 'red',
            position: 'center',
          }).showToast();
        }
        
      },
      async deployLoanContract(){
        const web3 = new Web3('http://localhost:8547');
        const accounts = await web3.eth.getAccounts();
        const networkId = await web3.eth.net.getId();
        const LoanContract = new web3.eth.Contract(
          LoanABI,
          null, 
          { data: '60806040523480156200001157600080fd5b506040516200182e3803806200182e833981810160405281019062000037919062000305565b336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555033600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508660038190555085600481905550846005819055508360088190555082600960006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600a90805190602001906200016f929190620001b5565b5080600b819055506005544262000187919062000432565b6006819055506000600760006101000a81548160ff02191690831515021790555050505050505050620005fa565b828054620001c39062000503565b90600052602060002090601f016020900481019282620001e7576000855562000233565b82601f106200020257805160ff191683800117855562000233565b8280016001018555821562000233579182015b828111156200023257825182559160200191906001019062000215565b5b50905062000242919062000246565b5090565b5b808211156200026157600081600090555060010162000247565b5090565b60006200027c6200027684620003ff565b620003cb565b9050828152602081018484840111156200029557600080fd5b620002a2848285620004cd565b509392505050565b600081519050620002bb81620005c6565b92915050565b600082601f830112620002d357600080fd5b8151620002e584826020860162000265565b91505092915050565b600081519050620002ff81620005e0565b92915050565b600080600080600080600060e0888a0312156200032157600080fd5b6000620003318a828b01620002ee565b9750506020620003448a828b01620002ee565b9650506040620003578a828b01620002ee565b95505060606200036a8a828b01620002ee565b94505060806200037d8a828b01620002aa565b93505060a088015167ffffffffffffffff8111156200039b57600080fd5b620003a98a828b01620002c1565b92505060c0620003bc8a828b01620002ee565b91505092959891949750929550565b6000604051905081810181811067ffffffffffffffff82111715620003f557620003f462000597565b5b8060405250919050565b600067ffffffffffffffff8211156200041d576200041c62000597565b5b601f19601f8301169050602081019050919050565b60006200043f82620004c3565b91506200044c83620004c3565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0382111562000484576200048362000539565b5b828201905092915050565b60006200049c82620004a3565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60005b83811015620004ed578082015181840152602081019050620004d0565b83811115620004fd576000848401525b50505050565b600060028204905060018216806200051c57607f821691505b6020821081141562000533576200053262000568565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b620005d1816200048f565b8114620005dd57600080fd5b50565b620005eb81620004c3565b8114620005f757600080fd5b50565b611224806200060a6000396000f3fe6080604052600436106100fe5760003560e01c80638da5cb5b11610095578063a6f9dae111610064578063a6f9dae1146102ef578063aa8c217c14610318578063bcead63e14610343578063e27facdc1461036e578063f966ade714610399576100fe565b80638da5cb5b1461023857806392d09ceb14610263578063a035b1fe1461028e578063a3b9e39d146102b9576100fe565b806357f7d74f116100d157806357f7d74f1461018e5780636164051a146101b7578063786716fe146101e25780637df1f1b91461020d576100fe565b80630b168f21146101035780630fb5a6b41461012e5780632c4e722e14610159578063330aec3e14610184575b600080fd5b34801561010f57600080fd5b506101186103a3565b6040516101259190610eb2565b60405180910390f35b34801561013a57600080fd5b50610143610431565b6040516101509190610f74565b60405180910390f35b34801561016557600080fd5b5061016e610437565b60405161017b9190610f74565b60405180910390f35b61018c61043d565b005b34801561019a57600080fd5b506101b560048036038101906101b09190610bc6565b610602565b005b3480156101c357600080fd5b506101cc610770565b6040516101d99190610e97565b60405180910390f35b3480156101ee57600080fd5b506101f7610783565b6040516102049190610f74565b60405180910390f35b34801561021957600080fd5b50610222610789565b60405161022f9190610dbb565b60405180910390f35b34801561024457600080fd5b5061024d6107ad565b60405161025a9190610dbb565b60405180910390f35b34801561026f57600080fd5b506102786107d3565b6040516102859190610f74565b60405180910390f35b34801561029a57600080fd5b506102a36107d9565b6040516102b09190610f74565b60405180910390f35b3480156102c557600080fd5b506102ce6107df565b6040516102e69c9b9a99989796959493929190610dd6565b60405180910390f35b3480156102fb57600080fd5b5061031660048036038101906103119190610bc6565b610953565b005b34801561032457600080fd5b5061032d610997565b60405161033a9190610f74565b60405180910390f35b34801561034f57600080fd5b5061035861099d565b6040516103659190610dbb565b60405180910390f35b34801561037a57600080fd5b506103836109c3565b6040516103909190610dbb565b60405180910390f35b6103a16109e9565b005b600a80546103b090611107565b80601f01602080910402602001604051908101604052809291908181526020018280546103dc90611107565b80156104295780601f106103fe57610100808354040283529160200191610429565b820191906000526020600020905b81548152906001019060200180831161040c57829003601f168201915b505050505081565b60055481565b60045481565b606460045460035461044f9190611032565b6104599190611001565b6003546104669190610fab565b34146104a7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161049e90610ef4565b60405180910390fd5b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610535576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161052c90610f54565b60405180910390fd5b60065442111561057a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161057190610f34565b60405180910390fd5b6001600760006101000a81548160ff021916908315150217905550600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6008549081150290604051600060405180830381858888f193505050501580156105ff573d6000803e3d6000fd5b50565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614806106ac5750600073ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b6106eb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106e290610f14565b60405180910390fd5b80600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600760009054906101000a900460ff1681565b60065481565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60085481565b600b5481565b600080600080600080600080600080606060008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600354600454600554600654600760009054906101000a900460ff16600854600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600a600b548180546108ad90611107565b80601f01602080910402602001604051908101604052809291908181526020018280546108d990611107565b80156109265780601f106108fb57610100808354040283529160200191610926565b820191906000526020600020905b81548152906001019060200180831161090957829003601f168201915b505050505091509b509b509b509b509b509b509b509b509b509b509b509b50909192939495969798999a9b565b80600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b60035481565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600760009054906101000a900460ff1615610a39576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a3090610ed4565b60405180910390fd5b600654421115610abe57600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc60085447610a8d9190610fab565b9081150290604051600060405180830381858888f19350505050158015610ab8573d6000803e3d6000fd5b50610baf565b6064600454600354610ad09190611032565b610ada9190611001565b600354610ae79190610fab565b3414610b28576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b1f90610ef4565b60405180910390fd5b6001600760006101000a81548160ff021916908315150217905550600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6008549081150290604051600060405180830381858888f19350505050158015610bad573d6000803e3d6000fd5b505b565b600081359050610bc0816111d7565b92915050565b600060208284031215610bd857600080fd5b6000610be684828501610bb1565b91505092915050565b610bf88161108c565b82525050565b610c078161109e565b82525050565b6000610c1882610f8f565b610c228185610f9a565b9350610c328185602086016110d4565b610c3b816111c6565b840191505092915050565b6000610c53601683610f9a565b91507f4c6f616e20697320616c726561647920726570616964000000000000000000006000830152602082019050919050565b6000610c93601a83610f9a565b91507f496e636f72726563742072657061796d656e7420616d6f756e740000000000006000830152602082019050919050565b6000610cd3602983610f9a565b91507f4f6e6c792063757272656e74206c656e6465722063616e206368616e6765207460008301527f6865206c656e64657200000000000000000000000000000000000000000000006020830152604082019050919050565b6000610d39601783610f9a565b91507f4c6f616e20697320616c7265616479206f7665726475650000000000000000006000830152602082019050919050565b6000610d79602083610f9a565b91507f4f6e6c7920626f72726f7765722063616e206d616b652072657061796d656e746000830152602082019050919050565b610db5816110ca565b82525050565b6000602082019050610dd06000830184610bef565b92915050565b600061018082019050610dec600083018f610bef565b610df9602083018e610bef565b610e06604083018d610bef565b610e13606083018c610dac565b610e20608083018b610dac565b610e2d60a083018a610dac565b610e3a60c0830189610dac565b610e4760e0830188610bfe565b610e55610100830187610dac565b610e63610120830186610bef565b818103610140830152610e768185610c0d565b9050610e86610160830184610dac565b9d9c50505050505050505050505050565b6000602082019050610eac6000830184610bfe565b92915050565b60006020820190508181036000830152610ecc8184610c0d565b905092915050565b60006020820190508181036000830152610eed81610c46565b9050919050565b60006020820190508181036000830152610f0d81610c86565b9050919050565b60006020820190508181036000830152610f2d81610cc6565b9050919050565b60006020820190508181036000830152610f4d81610d2c565b9050919050565b60006020820190508181036000830152610f6d81610d6c565b9050919050565b6000602082019050610f896000830184610dac565b92915050565b600081519050919050565b600082825260208201905092915050565b6000610fb6826110ca565b9150610fc1836110ca565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610ff657610ff5611139565b5b828201905092915050565b600061100c826110ca565b9150611017836110ca565b92508261102757611026611168565b5b828204905092915050565b600061103d826110ca565b9150611048836110ca565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048311821515161561108157611080611139565b5b828202905092915050565b6000611097826110aa565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60005b838110156110f25780820151818401526020810190506110d7565b83811115611101576000848401525b50505050565b6000600282049050600182168061111f57607f821691505b6020821081141561113357611132611197565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000601f19601f8301169050919050565b6111e08161108c565b81146111eb57600080fd5b5056fea2646970667358221220ae8d15f5dfa905a9b32a2e30928e8fd15a09d9a4f626de48254eaa064757a8c764736f6c63430008000033'}
        );
        const gas = 3000000; // Set the gas limit to 3000000
        const options = {
          from: accounts[0],
          gas: gas, // Pass the gas limit to the send method
        };

        
        var account = null;
        const response = fetch("http://127.0.0.1:8000/get_address/", {
                method: "POST", 
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'username': localStorage.getItem('username'), 
                }),
                
            }).then(response => response.json())
            .then(data=>{
                if (data.error){
                    console.log(error)
                }
                else{
                    this.form.collateralHolder = data.key
                    for (let i = 0; i < accounts.length; i++) {

                      if (JSON.stringify(accounts[i].toLowerCase()) === JSON.stringify(data.key.toLowerCase())) {
                        account = accounts[i];
                        break;
                      }
                    }
                    
                    //this.senderPassword = localStorage.getItem('password')
                }
            });
          
        
        this.borrower = accounts[accounts.length-5]
        for (let i = 0; i < accounts.length; i++) {
          if (JSON.stringify(accounts[i].toLowerCase()) === JSON.stringify(this.borrower.toLowerCase())) {
            account = accounts[i];
            const args = [
          this.form.amount, // amount
          this.form.rate, // rate
          this.form.duration, // duration
          this.form.collateralAmount, // collateralAmount
         account, // collateralHolder
          this.form.collateralUrl, 
          this.form.price,
        ];

        try{
          const contract = await LoanContract.deploy({
            arguments: args
          }).send(options);
          
          this.loanContractAddress = contract.options.address;
          this.loanContractInstance = new web3.eth.Contract(
            LoanABI, 
            this.loanContractAddress,
          ) 
          const response= fetch("http://127.0.0.1:8000/contracts/",{
            method: "PUT", 
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'address': this.loanContractAddress, 
                }),

          })
          Toastify({
            text: `Deployed loan contract ` + this.loanContractAddress +" "+ this.borrower ,
            backgroundColor: 'green',
            position: 'center',
          }).showToast();

        } catch(error){
          Toastify({
            text: `Error deploying contract: ${error}`,
            backgroundColor: 'red',
            position: 'center',
          }).showToast();

        }
            break;
          }
        }



      },

     
    },
  };
  </script>
  